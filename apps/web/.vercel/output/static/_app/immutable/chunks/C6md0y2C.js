import{c as u,a as b,O as g,t as I,b as T,e as l}from"./CKx7fsl1.js";const a=t=>u((e,o)=>{t.onerror=s=>o(new Error(s.target.error)),t.onsuccess=s=>e(s.target.result)}),B=(t,e)=>u((o,s)=>{const r=indexedDB.open(t);r.onupgradeneeded=n=>e(n.target.result),r.onerror=n=>s(b(n.target.error)),r.onsuccess=n=>{const d=n.target.result;d.onversionchange=()=>{d.close()},o(d)}}),D=t=>a(indexedDB.deleteDatabase(t)),U=(t,e)=>e.forEach(o=>t.createObjectStore.apply(t,o)),c=(t,e,o="readwrite")=>{const s=t.transaction(e,o);return e.map(r=>k(s,r))},p=(t,e)=>a(t.count(e)),S=(t,e)=>a(t.get(e)),y=(t,e)=>a(t.delete(e)),R=(t,e,o)=>a(t.put(e,o)),i=(t,e)=>a(t.add(e)),A=(t,e,o)=>a(t.getAll(e,o)),K=(t,e,o)=>{let s=null;return x(t,e,r=>(s=r,!1),o).then(()=>s)},E=(t,e=null)=>K(t,e,"prev"),w=(t,e)=>u((o,s)=>{t.onerror=s,t.onsuccess=async r=>{const n=r.target.result;if(n===null||await e(n)===!1)return o();n.continue()}}),x=(t,e,o,s="next")=>w(t.openKeyCursor(e,s),r=>o(r.key)),k=(t,e)=>t.objectStore(e),z=(t,e)=>IDBKeyRange.upperBound(t,e),C=(t,e)=>IDBKeyRange.lowerBound(t,e),h="custom",_="updates",f=500,m=(t,e=()=>{},o=()=>{})=>{const[s]=c(t.db,[_]);return A(s,C(t._dbref,!1)).then(r=>{t._destroyed||(e(s),I(t.doc,()=>{r.forEach(n=>T(t.doc,n))},t,!1),o(s))}).then(()=>E(s).then(r=>{t._dbref=r+1})).then(()=>p(s).then(r=>{t._dbsize=r})).then(()=>s)},O=(t,e=!0)=>m(t).then(o=>{(e||t._dbsize>=f)&&i(o,l(t.doc)).then(()=>y(o,z(t._dbref,!0))).then(()=>p(o).then(s=>{t._dbsize=s}))});class j extends g{constructor(e,o){super(),this.doc=o,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=B(e,s=>U(s,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=u(s=>this.on("synced",()=>s(this))),this._db.then(s=>{this.db=s,m(this,d=>i(d,l(o)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(s,r)=>{if(this.db&&r!==this){const[n]=c(this.db,[_]);i(n,s),++this._dbsize>=f&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{O(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},o.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),o.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{D(this.name)})}get(e){return this._db.then(o=>{const[s]=c(o,[h],"readonly");return S(s,e)})}set(e,o){return this._db.then(s=>{const[r]=c(s,[h]);return R(r,o,e)})}del(e){return this._db.then(o=>{const[s]=c(o,[h]);return y(s,e)})}}export{j as IndexeddbPersistence,f as PREFERRED_TRIM_SIZE,m as fetchUpdates,O as storeState};
//# sourceMappingURL=C6md0y2C.js.map
