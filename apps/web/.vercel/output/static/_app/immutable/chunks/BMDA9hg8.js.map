{"version":3,"file":"BMDA9hg8.js","sources":["../../../../../../../../packages/core/dist/services/scraper.js"],"sourcesContent":["/**\n * Song scraper for ozbcoz.com\n *\n * Searches and imports ChordPro songs from the ozbcoz.com ukulele songbook.\n * Uses a CORS proxy for browser-based fetching.\n */\n// Public CORS proxies (fallback chain)\nconst CORS_PROXIES = [\n    'https://corsproxy.io/?',\n    'https://api.allorigins.win/raw?url=',\n];\nconst OZBCOZ_BASE = 'https://ozbcoz.com/Songs/';\n/**\n * Fetch with CORS proxy fallback\n */\nasync function fetchWithProxy(url) {\n    // Try direct fetch first (might work in some environments)\n    try {\n        const response = await fetch(url, { mode: 'cors' });\n        if (response.ok) {\n            return await response.text();\n        }\n    }\n    catch {\n        // Fall through to proxy\n    }\n    // Try each proxy in order\n    for (const proxy of CORS_PROXIES) {\n        try {\n            const proxyUrl = proxy + encodeURIComponent(url);\n            const response = await fetch(proxyUrl);\n            if (response.ok) {\n                return await response.text();\n            }\n        }\n        catch {\n            // Try next proxy\n        }\n    }\n    throw new Error(`Failed to fetch ${url} - all proxies failed`);\n}\n/**\n * Parse the song listing page HTML to extract search results\n */\nfunction parseSongListHtml(html) {\n    const results = [];\n    // Match song links: song.php?ID=1234,soprano pattern\n    // Format: <a href=\"song.php?ID=6691,soprano\">'Round The Bay Of Mexico</a> [G] (2346)\n    const songLinkRegex = /<a\\s+href=\"song\\.php\\?ID=(\\d+),([^\"]+)\"[^>]*>([^<]+)<\\/a>\\s*(?:\\[([A-G][#b]?m?)\\])?\\s*(?:\\((\\d+)\\))?/gi;\n    let match;\n    while ((match = songLinkRegex.exec(html)) !== null) {\n        const [, id, , title, key, pageNumber] = match;\n        // Try to extract artist from surrounding context\n        // Often formatted as: Title - Artist or just Title\n        const cleanTitle = title.trim();\n        let songTitle = cleanTitle;\n        let artist;\n        // Check if title contains \" - \" for artist separation\n        const dashIndex = cleanTitle.lastIndexOf(' - ');\n        if (dashIndex > 0) {\n            songTitle = cleanTitle.substring(0, dashIndex).trim();\n            artist = cleanTitle.substring(dashIndex + 3).trim();\n        }\n        results.push({\n            id,\n            title: songTitle,\n            artist,\n            key: key || undefined,\n            pageNumber: pageNumber || undefined,\n            url: `${OZBCOZ_BASE}song.php?ID=${id},soprano`,\n        });\n    }\n    return results;\n}\n/**\n * Parse individual song page HTML to extract ChordPro content\n */\nfunction parseSongPageHtml(html, id) {\n    // Extract title\n    const titleMatch = html.match(/<h1[^>]*>([^<]+)<\\/h1>/i) ||\n        html.match(/<title>([^<]+)<\\/title>/i);\n    let title = titleMatch ? titleMatch[1].trim() : 'Unknown';\n    // Clean up title (remove \"- ozbcoz.com\" suffix if present)\n    title = title.replace(/\\s*[-â€“]\\s*ozbcoz\\.com.*$/i, '').trim();\n    // Extract artist\n    const artistMatch = html.match(/(?:Artist|By)[:\\s]*([^<\\n]+)/i);\n    const artist = artistMatch ? artistMatch[1].trim() : undefined;\n    // Extract writer\n    const writerMatch = html.match(/(?:Writer|Written by)[:\\s]*([^<\\n]+)/i);\n    const writer = writerMatch ? writerMatch[1].trim() : undefined;\n    // Extract key\n    const keyMatch = html.match(/(?:Key)[:\\s]*([A-G][#b]?m?)/i);\n    const key = keyMatch ? keyMatch[1] : undefined;\n    // Extract tempo\n    const tempoMatch = html.match(/(?:Tempo|BPM)[:\\s]*(\\d+)/i);\n    const tempo = tempoMatch ? parseInt(tempoMatch[1], 10) : undefined;\n    // Extract YouTube URL\n    const youtubeMatch = html.match(/(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]+)/i);\n    const youtubeUrl = youtubeMatch ? `https://www.youtube.com/watch?v=${youtubeMatch[1]}` : undefined;\n    // Extract the actual song content\n    // The content is typically in a <pre> tag or specific div\n    let content = '';\n    // Try to find ChordPro content in various containers\n    const preMatch = html.match(/<pre[^>]*class=\"[^\"]*chordpro[^\"]*\"[^>]*>([\\s\\S]*?)<\\/pre>/i);\n    if (preMatch) {\n        content = preMatch[1];\n    }\n    else {\n        // Try generic pre tag\n        const genericPreMatch = html.match(/<pre[^>]*>([\\s\\S]*?)<\\/pre>/i);\n        if (genericPreMatch) {\n            content = genericPreMatch[1];\n        }\n        else {\n            // Try div with song content\n            const divMatch = html.match(/<div[^>]*class=\"[^\"]*song[^\"]*\"[^>]*>([\\s\\S]*?)<\\/div>/i);\n            if (divMatch) {\n                content = divMatch[1];\n            }\n        }\n    }\n    // Clean up HTML entities and tags in content\n    content = content\n        .replace(/<br\\s*\\/?>/gi, '\\n')\n        .replace(/<[^>]+>/g, '')\n        .replace(/&nbsp;/g, ' ')\n        .replace(/&amp;/g, '&')\n        .replace(/&lt;/g, '<')\n        .replace(/&gt;/g, '>')\n        .replace(/&quot;/g, '\"')\n        .replace(/&#39;/g, \"'\")\n        .trim();\n    // If content is empty, try to reconstruct from visible chord/lyric structure\n    if (!content) {\n        content = extractChordProFromStructuredHtml(html);\n    }\n    // Build ChordPro header if not already present\n    if (!content.includes('{title:') && !content.includes('{t:')) {\n        const header = buildChordProHeader(title, artist, key, tempo);\n        content = header + '\\n' + content;\n    }\n    return {\n        id,\n        title,\n        artist,\n        writer,\n        key,\n        tempo,\n        content,\n        youtubeUrl,\n    };\n}\n/**\n * Extract ChordPro content from structured HTML with separate chord/lyric lines\n */\nfunction extractChordProFromStructuredHtml(html) {\n    const lines = [];\n    // Look for table rows with chord and lyric cells\n    // Pattern: <tr><td class=\"chord\">G</td>...</tr><tr><td class=\"lyric\">word</td>...</tr>\n    const rowRegex = /<tr[^>]*>([\\s\\S]*?)<\\/tr>/gi;\n    const cellRegex = /<td[^>]*>([\\s\\S]*?)<\\/td>/gi;\n    const rows = [];\n    let rowMatch;\n    while ((rowMatch = rowRegex.exec(html)) !== null) {\n        const cells = [];\n        let cellMatch;\n        const rowContent = rowMatch[1];\n        while ((cellMatch = cellRegex.exec(rowContent)) !== null) {\n            cells.push(cellMatch[1].replace(/<[^>]+>/g, '').trim());\n        }\n        if (cells.length > 0) {\n            rows.push(cells);\n        }\n    }\n    // Process rows in pairs (chord row + lyric row)\n    for (let i = 0; i < rows.length; i += 2) {\n        const chordRow = rows[i];\n        const lyricRow = rows[i + 1] || [];\n        // Merge chords into lyrics\n        let line = '';\n        for (let j = 0; j < Math.max(chordRow.length, lyricRow.length); j++) {\n            const chord = chordRow[j] || '';\n            const lyric = lyricRow[j] || '';\n            if (chord) {\n                line += `[${chord}]`;\n            }\n            line += lyric;\n        }\n        if (line.trim()) {\n            lines.push(line);\n        }\n    }\n    return lines.join('\\n');\n}\n/**\n * Build ChordPro header directives\n */\nfunction buildChordProHeader(title, artist, key, tempo) {\n    const parts = [];\n    parts.push(`{title: ${title}}`);\n    if (artist) {\n        parts.push(`{artist: ${artist}}`);\n    }\n    if (key) {\n        parts.push(`{key: ${key}}`);\n    }\n    if (tempo) {\n        parts.push(`{tempo: ${tempo}}`);\n    }\n    return parts.join('\\n');\n}\n/**\n * Search for songs on ozbcoz.com\n */\nexport async function searchOzbcozSongs(query) {\n    // The site uses client-side filtering, so we fetch the full list and filter locally\n    const url = `${OZBCOZ_BASE}index.php?sort=ttl`;\n    const html = await fetchWithProxy(url);\n    const allResults = parseSongListHtml(html);\n    // Filter results by query\n    const queryLower = query.toLowerCase();\n    return allResults.filter(song => song.title.toLowerCase().includes(queryLower) ||\n        (song.artist && song.artist.toLowerCase().includes(queryLower)));\n}\n/**\n * Get full song details including ChordPro content\n */\nexport async function getOzbcozSongDetail(songId) {\n    const url = `${OZBCOZ_BASE}song.php?ID=${songId},soprano`;\n    const html = await fetchWithProxy(url);\n    return parseSongPageHtml(html, songId);\n}\n/**\n * Convert ozbcoz song detail to our Song model format\n */\nexport function convertToGigwidgetSong(detail, _userId) {\n    return {\n        title: detail.title,\n        artist: detail.artist || detail.writer,\n        key: detail.key, // Will be validated by the model\n        tempo: detail.tempo,\n        content: detail.content,\n        tags: ['imported', 'ozbcoz'],\n    };\n}\n//# sourceMappingURL=scraper.js.map"],"names":["CORS_PROXIES","OZBCOZ_BASE","fetchWithProxy","url","response","proxy","proxyUrl","parseSongListHtml","html","results","songLinkRegex","match","id","title","key","pageNumber","cleanTitle","songTitle","artist","dashIndex","parseSongPageHtml","titleMatch","artistMatch","writerMatch","writer","keyMatch","tempoMatch","tempo","youtubeMatch","youtubeUrl","content","preMatch","genericPreMatch","divMatch","extractChordProFromStructuredHtml","buildChordProHeader","lines","rowRegex","cellRegex","rows","rowMatch","cells","cellMatch","rowContent","i","chordRow","lyricRow","line","j","chord","lyric","parts","searchOzbcozSongs","query","allResults","queryLower","song","getOzbcozSongDetail","songId","convertToGigwidgetSong","detail","_userId"],"mappings":"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"}